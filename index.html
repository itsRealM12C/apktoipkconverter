<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>APK to IPK Converter</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>APK to IPK Converter</h1>
    <form id="uploadForm">
      <label for="apkFile">Choose APK file:</label>
      <input type="file" id="apkFile" name="apkFile" accept=".apk" required>
      <button type="submit">Convert</button>
    </form>
    <div id="result"></div>
  </div>
  <script src="script.js"></script>

<script>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>

void handle_conversion(const char *input_file, const char *output_file);

int main() {
    printf("Content-Type: application/octet-stream\n");
    printf("Content-Disposition: attachment; filename=\"converted.ipk\"\n\n");

    char apk_file[] = "/tmp/uploaded.apk";
    char ipk_file[] = "/tmp/converted.ipk";

    // Save uploaded APK file
    FILE *apk_fp = fopen(apk_file, "wb");
    if (!apk_fp) {
        perror("Failed to open temporary APK file");
        return EXIT_FAILURE;
    }

    // Read input from stdin (CGI POST data)
    char buffer[8192];
    size_t bytes;
    while ((bytes = fread(buffer, 1, sizeof(buffer), stdin)) > 0) {
        fwrite(buffer, 1, bytes, apk_fp);
    }
    fclose(apk_fp);

    // Perform conversion
    handle_conversion(apk_file, ipk_file);

    // Send IPK file to stdout
    FILE *ipk_fp = fopen(ipk_file, "rb");
    if (!ipk_fp) {
        perror("Failed to open IPK file");
        return EXIT_FAILURE;
    }

    while ((bytes = fread(buffer, 1, sizeof(buffer), ipk_fp)) > 0) {
        fwrite(buffer, 1, bytes, stdout);
    }
    fclose(ipk_fp);

    // Cleanup
    remove(apk_file);
    remove(ipk_file);

    return EXIT_SUCCESS;
}

void handle_conversion(const char *input_file, const char *output_file) {
    // Conversion logic here
    // (Reusing the previously shared APK-to-IPK conversion logic)
}

</script>
</body>
</html>
